import xml.etree.ElementTree as ET
import matplotlib.pyplot as plt
from collections import Counter, defaultdict

def load_users_data(file_path="users.xml"):
    tree = ET.parse(file_path)
    root = tree.getroot()

    users = []
    for user_elem in root.findall("user"):
        user = {
            "user_id": int(user_elem.find("user_id").text), #словарь с значением
            "name": user_elem.find("name").text,
            "age": int(user_elem.find("age").text),
            "weight": int(user_elem.find("weight").text),
            "fitness_level": user_elem.find("fitness_level").text
        }
        users.append(user)

    return users

    
def load_workouts_data(file_path="workouts.xml"):
    tree = ET.parse(file_path)
    root = tree.getroot()

    workouts = []
    for workout_elem in root.findall("workout"):
        workout = {
            "workout_id": int(workout_elem.find("workout_id").text),
            "user_id": int(workout_elem.find("user_id").text),
            "date": workout_elem.find("date").text,
            "type": workout_elem.find("type").text,
            "duration": int(workout_elem.find("duration").text),
            "distance": float(workout_elem.find("distance").text),
            "calories": int(workout_elem.find("calories").text),
            "avg_heart_rate": int(workout_elem.find("avg_heart_rate").text),
            "intensity": workout_elem.find("intensity").text
        }
        workouts.append(workout)

    return workouts

def print_general_stats(users, workouts):
    total_workouts = len(workouts)
    total_users = len(users)
    total_calories = sum(w["calories"] for w in workouts) #присваиваем w значение из списка и пропускаем через цикл
    total_duration_hours = sum(w["duration"] for w in workouts) / 60.0
    total_distance = sum(w["distance"] for w in workouts)

    print("ОБЩАЯ СТАТИСТИКА")
    print("=====================")
    print(f"Всего тренировок: {total_workouts}")
    print(f"Всего пользователей: {total_users}")
    print(f"Сожжено калорий: {total_calories}")
    print(f"Общее время: {round(total_duration_hours, 1)} часов")
    print(f"Пройдено дистанции: {round(total_distance, 1)} км")
    print()

    def analyze_user_activity(users, workouts):
    user_stats = []

    for user in users:
        user_workouts = [w for w in workouts if w["user_id"] == user["user_id"]] #Берем каждую тренировку w из списка workouts и добавляем её в новый список,если user_id тренировки равен user_id пользователя.
        total_workouts = len(user_workouts)
        total_calories = sum(w["calories"] for w in user_workouts)
        total_time_hours = sum(w["duration"] for w in user_workouts) / 60.0

        if total_workouts > 0: #Проверяется, есть ли у пользователя хотя бы одна тренировка
            user_stats.append({ #формируем словарь
                "name": user["name"],
                "fitness_level": user["fitness_level"],
                "total_workouts": total_workouts,
                "total_calories": total_calories,
                "total_time_hours": total_time_hours
            })

    user_stats.sort(key=lambda x: x["total_workouts"], reverse=True) №Сортировка списка пользователей по убыванию количества тренировок.

    print("ТОП-3 АКТИВНЫХ ПОЛЬЗОВАТЕЛЕЙ:")
    print()

    for i, stats in enumerate(user_stats[:3], 1): #Берутся первые 3 пользователя из списка — самые активные.
        print(f"{i}. {stats['name']} ({stats['fitness_level']}):")
        print(f"Тренировок: {stats['total_workouts']}")
        print(f"Калорий: {stats['total_calories']}")
        print(f"Время: {round(stats['total_time_hours'], 1)} часов")
        print()

