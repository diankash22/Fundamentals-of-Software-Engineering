import xml.etree.ElementTree as ET
import matplotlib.pyplot as plt
from collections import Counter, defaultdict

def load_users_data(file_path="users.xml"):
    tree = ET.parse(file_path)
    root = tree.getroot()

    users = []
    for user_elem in root.findall("user"):
        user = {
            "user_id": int(user_elem.find("user_id").text), #словарь с значением
            "name": user_elem.find("name").text,
            "age": int(user_elem.find("age").text),
            "weight": int(user_elem.find("weight").text),
            "fitness_level": user_elem.find("fitness_level").text
        }
        users.append(user)

    return users

    
def load_workouts_data(file_path="workouts.xml"):
    tree = ET.parse(file_path)
    root = tree.getroot()

    workouts = []
    for workout_elem in root.findall("workout"):
        workout = {
            "workout_id": int(workout_elem.find("workout_id").text),
            "user_id": int(workout_elem.find("user_id").text),
            "date": workout_elem.find("date").text,
            "type": workout_elem.find("type").text,
            "duration": int(workout_elem.find("duration").text),
            "distance": float(workout_elem.find("distance").text),
            "calories": int(workout_elem.find("calories").text),
            "avg_heart_rate": int(workout_elem.find("avg_heart_rate").text),
            "intensity": workout_elem.find("intensity").text
        }
        workouts.append(workout)

    return workouts

def print_general_stats(users, workouts):
    total_workouts = len(workouts)
    total_users = len(users)
    total_calories = sum(w["calories"] for w in workouts) #присваиваем w значение из списка и пропускаем через цикл
    total_duration_hours = sum(w["duration"] for w in workouts) / 60.0
    total_distance = sum(w["distance"] for w in workouts)

    print("ОБЩАЯ СТАТИСТИКА")
    print("=====================")
    print(f"Всего тренировок: {total_workouts}")
    print(f"Всего пользователей: {total_users}")
    print(f"Сожжено калорий: {total_calories}")
    print(f"Общее время: {round(total_duration_hours, 1)} часов")
    print(f"Пройдено дистанции: {round(total_distance, 1)} км")
    print()

    def analyze_user_activity(users, workouts):
    user_stats = []

    for user in users:
        user_workouts = [w for w in workouts if w["user_id"] == user["user_id"]] #Берем каждую тренировку w из списка workouts и добавляем её в новый список,если user_id тренировки равен user_id пользователя.
        total_workouts = len(user_workouts)
        total_calories = sum(w["calories"] for w in user_workouts)
        total_time_hours = sum(w["duration"] for w in user_workouts) / 60.0

        if total_workouts > 0: #Проверяется, есть ли у пользователя хотя бы одна тренировка
            user_stats.append({ #формируем словарь
                "name": user["name"],
                "fitness_level": user["fitness_level"],
                "total_workouts": total_workouts,
                "total_calories": total_calories,
                "total_time_hours": total_time_hours
            })

    user_stats.sort(key=lambda x: x["total_workouts"], reverse=True) #Сортировка списка пользователей по убыванию количества тренировок.

    print("ТОП-3 АКТИВНЫХ ПОЛЬЗОВАТЕЛЕЙ:")
    print()

    for i, stats in enumerate(user_stats[:3], 1): #Берутся первые 3 пользователя из списка — самые активные.
        print(f"{i}. {stats['name']} ({stats['fitness_level']}):")
        print(f"Тренировок: {stats['total_workouts']}")
        print(f"Калорий: {stats['total_calories']}")
        print(f"Время: {round(stats['total_time_hours'], 1)} часов")
        print()

def analyze_workout_types(workouts):
    workout_types_data = defaultdict(list)

    for workout in workouts:
        workout_types_data[workout["type"]].append(workout) #Берётся тип тренировки и: если такого типа ещё нет — создаётся пустой список текущая тренировка добавляется в список этого типа

    total_workouts = len(workouts)

    print("РАСПРЕДЕЛЕНИЕ ПО ТИПАМ ТРЕНИРОВОК:")

    for workout_type in sorted(workout_types_data.keys()): #сортировка по алфавиту
        type_workouts = workout_types_data[workout_type]
        type_count = len(type_workouts)
        percentage = round(type_count / total_workouts * 100, 1)
        avg_duration = sum(w["duration"] for w in type_workouts) / type_count #Средняя длительность: Складываются все минуты,Делится на количество тренировок
        avg_calories = sum(w["calories"] for w in type_workouts) // type_count

        print(f"{workout_type.capitalize()}: {type_count} тренировок ({percentage}%)") #Тип тренировки с большой буквы + сколько раз встречается + процент
        print(f"Средняя длительность: {int(avg_duration)} мин")
        print(f"Средние калории: {avg_calories} ккал")

def analyze_user(users, workouts, user_name):
    user = next((user for user in users if user["name"] == user_name), None)

    if user is None:
        print(f"Пользователь с именем '{user_name}' не найден.")
        return

    user_workouts = [w for w in workouts if w["user_id"] == user["user_id"]] #перебираем workouts, добавляем w в результат, только если w["user_id"] совпадает с user["user_id"]
        if not user_workouts:
        print(f"У пользователя '{user_name}' нет тренировок.")
        return

    total_workouts = len(user_workouts)
    total_calories = sum(w["calories"] for w in user_workouts)
    total_time_hours = sum(w["duration"] for w in user_workouts) / 60.0
    total_distance = sum(w["distance"] for w in user_workouts)
    avg_calories_per_workout = total_calories // total_workouts

    workout_type_counter = Counter(w["type"] for w in user_workouts)
    favorite_workout_type = workout_type_counter.most_common(1)[0][0] #most_common(1)  список из 1 самого частого элемента, [0]  берём первый кортеж,[0]берём первый элемент из кортежа

        print(f"ДЕТАЛЬНЫЙ АНАЛИЗ ДЛЯ ПОЛЬЗОВАТЕЛЯ: {user_name}")
    print("=" * 76)
    print(f"Возраст: {user['age']} лет, Вес: {user['weight']} кг")
    print(f"Уровень: {user['fitness_level']}")
    print(f"Тренировок: {total_workouts}")
    print(f"Сожжено калорий: {total_calories}")
    print(f"Общее время: {round(total_time_hours, 1)} часов")
    print(f"Пройдено дистанции: {round(total_distance, 1)} км")
    print(f"Средние калории за тренировку: {avg_calories_per_workout}")
    print(f"Любимый тип тренировки: {favorite_workout_type}")

    def plot_workout_types_pie(workouts):
    workout_counts = {} #словарь

    for workout in workouts:
        workout_type = workout["type"]
        workout_counts[workout_type] = workout_counts.get(workout_type, 0) + 1 #берёт текущее количество этого типа, если типа ещё нет в словаре — возвращает 0. + 1 — увеличивает счётчик. результат записывается обратно по ключу workout_type

    labels = list(workout_counts.keys()) #Создаётся список подписей диаграммы — названия типов тренировок.
    sizes = list(workout_counts.values()) #Создаётся список чисел — сколько тренировок каждого типа.

    plt.figure(figsize=(8, 8)) #Создаётся новая фигура (окно) диаграммы размером 8×8 дюймов.
    plt.pie(sizes, labels=labels, autopct='%1.1f%%', startangle=90) #autopct='%1.1f%%' — отображение процентов (1 знак после запятой), startangle=90 — поворот начала диаграммы на 90°
    plt.title("Распределение типов тренировок")
    plt.axis('equal') #Делает круг ровным, а не овальным.
    plt.show()

def plot_user_activity_bar(users, workouts):
    user_names = []
    workout_counts = []

    for user in users:
        user_workouts = [w for w in workouts if w["user_id"] == user["user_id"]] #Из всех тренировок выбираем только те, которые принадлежат текущему пользователю.
        count = len(user_workouts)
        user_names.append(user["name"]) #Добавляем имя пользователя в список user_names.
        workout_counts.append(count)

    plt.figure(figsize=(12, 6))
    plt.bar(user_names, workout_counts, color='skyblue')
    plt.title("Активность пользователей (количество тренировок)")
    plt.ylabel("Количество тренировок")
    plt.xlabel("Пользователи")
    plt.xticks(rotation=45)#Поворачивает имена пользователей на 45°, чтобы не наезжали друг на друга.

    for i, v in enumerate(workout_counts): #Перебираем все значения количества тренировок.
        plt.text(i, v + 0.1, str(v), ha='center') #Над каждым столбцом рисуется число:

    plt.tight_layout() #Автоматически подгоняет отступы, чтобы всё красиво помещалось.
    plt.show()

def plot_workout_efficiency_bar(workouts):
    total_calories_by_type = {}
    total_duration_by_type = {}
    count_by_type = {}

    for workout in workouts:
        workout_type = workout["type"]
        total_calories_by_type[workout_type] = total_calories_by_type.get(workout_type, 0) + workout["calories"] #Добавляем калории в нужный тип: если типа ещё нет — начальное значение 0, затем прибавляем калории.
        total_duration_by_type[workout_type] = total_duration_by_type.get(workout_type, 0) + workout["duration"]
        count_by_type[workout_type] = count_by_type.get(workout_type, 0) + 1 #Счётчик количества тренировок каждого типа
    workout_types = []
    efficiencies = []

    for workout_type in total_calories_by_type.keys(): #по каждому типу тренировки.
        efficiency = total_calories_by_type[workout_type] / total_duration_by_type[workout_type] #Формула эффективности:калории / минуты
        efficiency = round(efficiency, 2) #до двух знаков после запятой.
        workout_types.append(workout_type)
        efficiencies.append(efficiency)
    plt.figure(figsize=(10, 6))
    plt.bar(workout_types, efficiencies, color='lightgreen')
    plt.title("Эффективность тренировок (калории/минуту)")
    plt.ylabel("Калории в минуту")
    plt.xlabel("Тип тренировки")

    for i, v in enumerate(efficiencies):
        plt.text(i, v + 0.05, str(v), ha='center') #Пишем число над столбцами.

    plt.tight_layout()
    plt.show()

def plot_user_calories_comparison(users, workouts):
    user_calories = {}

    for user in users:
        user_workouts = [w for w in workouts if w["user_id"] == user["user_id"]]
        total_calories = sum(w["calories"] for w in user_workouts)
        user_calories[user["name"]] = total_calories

    sorted_users = sorted(user_calories.items(), key=lambda x: x[1], reverse=True) #Сортируем пользователей по калориям по убыванию
    user_names = [user[0] for user in sorted_users] #Создаётся список имён пользователей в отсортированном порядке.
    calories_values = [user[1] for user in sorted_users] #Создаётся список калорий в том же порядке.

    plt.figure(figsize=(12, 6))
    plt.bar(user_names, calories_values, color='orange')
    plt.title("Сравнение пользователей по общим затраченным калориям")
    plt.ylabel("Общие калории")
    plt.xlabel("Пользователи")
    plt.xticks(rotation=45)

    for i, v in enumerate(calories_values):
        plt.text(i, v + 50, str(v), ha='center')

    plt.tight_layout()
    plt.show()

def main():
    users = load_users_data()
    workouts = load_workouts_data()

    print("=" * 60)
    print("ЗАДАЧА 1: ОБЩАЯ СТАТИСТИКА")
    print("=" * 60)
    print_general_stats(users, workouts)

    print("=" * 60)
    print("ЗАДАЧА 2: АНАЛИЗ ДАННЫХ")
    print("=" * 60)
    analyze_user_activity(users, workouts)

    print("-" * 60)
    analyze_workout_types(workouts)

    print("-" * 60)
    analyze_user(users, workouts, "Борис")

    print("\n" + "=" * 60)
    print("ЗАДАЧА 3: ВИЗУАЛИЗАЦИЯ ДАННЫХ")
    print("=" * 60)

    print("\n1. Круговая диаграмма распределения типов тренировок...")
    plot_workout_types_pie(workouts)

    print("\n2. Столбчатая диаграмма активности пользователей...")
    plot_user_activity_bar(users, workouts)

    print("\n3. Столбчатая диаграмма эффективности тренировок...")
    plot_workout_efficiency_bar(workouts)

    print("\n4. Столбчатая диаграмма сравнения пользователей по калориям...")
    plot_user_calories_comparison(users, workouts)


if __name__ == "__main__":
    main()
