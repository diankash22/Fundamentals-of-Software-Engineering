import string
import re
file_commands = 'commands.1.txt'
file_proteins = 'sequences.1.txt'
file_output = 'genedata.1.txt'

def read_command(filename):
    proteins = []
    file = open(filename, 'r', encoding='utf-8')
    for line in file:
        parts = line.strip().split('\t') #разделяем строку по табуляции и после сохраняем как кортеж
        protein_data = (
            parts[0].strip(), #name
            parts[1].strip(), #organism
            parts[2].strip()  #sequence
        )
        proteins.append(protein_data)
    return proteins

def read_commands_data(filename):
    commands=[]
    file = open(filename, 'r',encoding='utf-8')
    for line in file:
        parts=line.strip().split('\t')
        commands_data= (
            parts[0].strip(),
            parts[1].strip(),
        )
        commands.append(commands_data)
    return commands

def decode(werb):
    word = ""
    i = 0
    while i < len(werb):
        if werb[i].isdigit(): #проверяем каждый элемени на то является ли цифрой
            if i + 1 >= len(werb): #защита от выхода за границу
                break
            count = int(werb[i]) #запоминаем какое число стоит на позиции i
            letter = werb[i+1]  #запоминаем букву которая идет после нашей цифры
            word += letter * count #преобразование
            i += 2 #переход к след цифре
        else:
            word += werb[i]
            i += 1
    return word

def search_data(protein):
    protein = decode(protein) #преобразование
    proteins = read_command(file_proteins)
    results = []
    for item in proteins:
        name = item[0]
        sequence = item[2] #последовательность белка
        organism = item[1] 

        if sequence.find(protein) != -1: #если последовательность найдена формируем результат
            results.append( organism + " " + name)
            break
    if len(results) == 0:
        return "NOT FOUND"
    else:
        return results

def mode(protein):
    if protein == "":
        return "MISSING"

    proteins = read_command(file_proteins)
    sequence = ''

    for item in proteins:
        if item[0] == protein:
            sequence = item[2]
            break

    if sequence = '':
        return "NOT FOUND"

    # Подсчет частоты аминокислот
    freq = {}
    for ch in sequence:
        freq[ch] = freq.get(ch, 0) + 1 #увеличение счетчика для каждой буквы,get ищет
        # если находит то присваивает индекс к ch,если нет то 0.+1 добавляет еще одно появление

    max_count = max(freq.values())

    # берём первую по алфавиту среди равных
    for ch in sorted(freq):
        if freq[ch] == max_count:
            return ch, max_count

def diff(protein1, protein2):
    proteins = read_command(file_proteins)
    
    f_protein1 = ''
    f_protein2 = ''

    for item in proteins:
        if item[0] == protein1:
            f_protein1 = item[2]
        if item[0] == protein2:
            f_protein2 = item[2]

    # Обработка отсутствующих белков
    missing = []
    if f_protein1 = '':
        missing.append(protein1)
    if f_protein2 = '':
        missing.append(protein2)

    if missing:
        return "MISSING: " + " ".join(missing)

    # Расчет различий
    if len(f_protein1) > len(f_protein2):
        max_p, min_p = f_protein1, f_protein2
    else:
        max_p, min_p = f_protein2, f_protein1

    diff_count = len(max_p) - len(min_p)

    for i in range(len(min_p)):
        if max_p[i] != min_p[i]:
            diff_count += 1

    return diff_count


def process_all():
    commands = read_commands_data(file_commands)

    with open(file_output, 'w', encoding='utf-8') as out:

        # первые две строки — по условию
        out.write("ТВОЁ ИМЯ\n")
        out.write("Генетический поиск\n")

        operation_number = 1

        for op, params in commands:
            out.write("\n" + f"{operation_number:03d}" + "\n")
            operation_number += 1

            if op == "search":
                out.write("search " + params[0] + "\n")
                results = search_data(params[0])
                for r in results:
                    out.write(r + "\n")

            elif op == "diff":
                protein1 = params[0]
                protein2 = params[1]
                out.write(f"diff {protein1} {protein2}\n")
                result = diff(protein1, protein2)
                out.write(result + "\n")

            elif op == "mode":
                protein = params[0]
                out.write("mode " + protein + "\n")
                result = mode(protein)
                out.write(str(result) + "\n")

            # линия разделения
            out.write("------------------------------\n")
